<div class="profile-container" *ngIf="!loading; else loadingTpl">
  <div class="profile-header">
    <h1>{{ canEdit ? (hasProfile ? 'Edit Your Profile' : 'Complete Your Profile') : 'User Profile' }}</h1>
  </div>

  <!-- Edit Mode -->
  <div *ngIf="canEdit" class="edit-mode">
    <mat-card class="profile-card">
      <mat-card-content>
        <form [formGroup]="profileForm" (ngSubmit)="onSubmit()">

          <!-- Profile Picture Section -->
          <div class="profile-picture-section">
            <div class="picture-preview">
              <img *ngIf="previewUrl" [src]="previewUrl" class="profile-img" />
              <img *ngIf="!previewUrl && profileData && profileData.profilePictureUrl"
                   [src]="getImageUrl(profileData.profilePictureUrl)"
                   class="profile-img" />
              <div *ngIf="!previewUrl && (!profileData || !profileData.profilePictureUrl)" class="no-image">
                <mat-icon>account_circle</mat-icon>
              </div>
            </div>
            <div class="picture-upload">
              <label for="profilePicture" class="upload-label">
                <mat-icon>photo_camera</mat-icon>
                <span>Upload Profile Picture</span>
              </label>
              <input id="profilePicture" type="file" accept="image/*"
                     (change)="onFileSelected($event)" style="display: none;" />
            </div>
          </div>

          <!-- Form Fields -->
          <div class="form-fields">
            <mat-form-field appearance="outline">
              <mat-label>First Name</mat-label>
              <input matInput formControlName="firstName" required />
              <mat-icon matPrefix>person</mat-icon>
              <mat-error *ngIf="profileForm.get('firstName')?.hasError('required')">
                First name is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Last Name</mat-label>
              <input matInput formControlName="lastName" required />
              <mat-icon matPrefix>person</mat-icon>
              <mat-error *ngIf="profileForm.get('lastName')?.hasError('required')">
                Last name is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Motto</mat-label>
              <input matInput formControlName="moto" placeholder="Your personal motto" />
              <mat-icon matPrefix>format_quote</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Biography</mat-label>
              <textarea matInput formControlName="biography" rows="4"
                        placeholder="Tell us about yourself..."></textarea>
              <mat-icon matPrefix>description</mat-icon>
            </mat-form-field>
          </div>

          <!-- Action Buttons -->
          <div class="form-actions">
            <button mat-raised-button color="primary" type="submit" [disabled]="profileForm.invalid">
              <mat-icon>save</mat-icon>
              {{ hasProfile ? 'Save Changes' : 'Create Profile' }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- View Mode -->
  <div *ngIf="!canEdit" class="view-mode">
    <mat-card class="profile-card" *ngIf="profileData">
      <mat-card-content>
        <div class="profile-view">
          <div class="profile-avatar">
            <img *ngIf="profileData && profileData.profilePictureUrl"
                 [src]="getImageUrl(profileData.profilePictureUrl)"
                 class="profile-img-large" />
            <div *ngIf="!profileData || !profileData.profilePictureUrl" class="no-image-large">
              <mat-icon>account_circle</mat-icon>
            </div>
          </div>

          <div class="profile-info">
            <h2>{{ profileData.firstName }} {{ profileData.lastName }}</h2>
            <p class="username">@{{ profileData.username }}</p>
            <p class="moto" *ngIf="profileData.moto">
              <mat-icon>format_quote</mat-icon>
              "{{ profileData.moto }}"
            </p>
            <p class="biography" *ngIf="profileData.biography">{{ profileData.biography }}</p>

            <!-- Follow/Unfollow Button -->
            <div class="follow-actions" *ngIf="user && user.id">
              <button mat-raised-button color="accent" *ngIf="!isFollowing" (click)="onFollow()">
                <mat-icon>person_add</mat-icon>
                Follow
              </button>
              <button mat-raised-button *ngIf="isFollowing" (click)="onUnfollow()">
                <mat-icon>person_remove</mat-icon>
                Unfollow
              </button>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="profile-card" *ngIf="!profileData">
      <mat-card-content>
        <div class="no-profile">
          <mat-icon>person_outline</mat-icon>
          <p>This user hasn't created their profile yet.</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Social Section -->
  <div class="social-section">
    <div class="social-column">
      <mat-card class="social-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>group</mat-icon>
            Followers ({{ followers.length }})
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="social-list" *ngIf="followers.length > 0">
            <div class="social-item" *ngFor="let f of followers">
              <mat-icon>person</mat-icon>
              <a [routerLink]="['/user-profile', f.id]">{{ f.username }}</a>
            </div>
          </div>
          <p *ngIf="followers.length === 0" class="empty-state">No followers yet</p>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="social-column">
      <mat-card class="social-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>people</mat-icon>
            Following ({{ following.length }})
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="social-list" *ngIf="following.length > 0">
            <div class="social-item" *ngFor="let f of following">
              <mat-icon>person</mat-icon>
              <a [routerLink]="['/user-profile', f.id]">{{ f.username }}</a>
            </div>
          </div>
          <p *ngIf="following.length === 0" class="empty-state">Not following anyone yet</p>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="social-column" *ngIf="recommendations.length > 0">
      <mat-card class="social-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>recommend</mat-icon>
            Recommendations
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="social-list">
            <div class="social-item recommendation" *ngFor="let rec of recommendations">
              <mat-icon>person_add</mat-icon>
              <div class="recommendation-info">
                <a [routerLink]="['/user-profile', rec.userDto.id]">{{ rec.userDto.username }}</a>
                <span class="mutual-count">{{ rec.mutualCount }} mutual friends</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="loading-container">
    <mat-icon class="loading-icon">hourglass_empty</mat-icon>
    <p>Loading profile...</p>
  </div>
</ng-template>
